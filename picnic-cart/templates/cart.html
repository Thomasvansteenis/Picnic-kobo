{% extends "base.html" %}

{% block title %}Shopping Cart - Picnic{% endblock %}

{% block content %}
<h1>Shopping Cart</h1>

{% if cart and cart['items'] %}
    <div class="cart-summary">
        <div class="cart-total">
            Total Items: {{ cart['total_count'] or cart['items']|length or 0 }}
        </div>
        {% if cart['total_price'] %}
        <div class="cart-total">
            Total Price: €{{ "%.2f"|format(cart['total_price'] / 100) }}
        </div>
        {% endif %}
    </div>

    {% for item in cart['items'] %}
    {% set article = item['items'][0] if item.get('items') and item['items']|length > 0 else {} %}
    {% set quantity_decorator = article.get('decorators', [])|selectattr('type', 'equalto', 'QUANTITY')|first if article else none %}
    <div class="cart-item">
        <div class="item-name">
            {{ article.get('name', 'Unknown Product') }}
        </div>
        <div class="item-info">
            Quantity: {{ quantity_decorator.quantity if quantity_decorator else 0 }}
        </div>
        {% if item.get('price') or article.get('price') %}
        <div class="item-price">
            Price: €{{ "%.2f"|format((item.get('price') or article.get('price')) / 100) }}
        </div>
        {% endif %}
        {% if article.get('unit_quantity') %}
        <div class="item-info">
            {{ article['unit_quantity'] }}
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('remove_from_cart') }}" style="margin-top: 10px;">
            <input type="hidden" name="product_id" value="{{ article.get('id', item.get('id')) }}">
            <input type="number" name="quantity" value="1" min="1" max="{{ quantity_decorator.quantity if quantity_decorator else 1 }}" style="width: 80px; display: inline-block;">
            <button type="submit">Remove</button>
        </form>
    </div>
    {% endfor %}

    <div style="margin-top: 20px;">
        <form method="POST" action="{{ url_for('clear_cart') }}" onsubmit="return confirm('Clear entire cart?');">
            <button type="submit" style="background: #fff; border: 2px solid #000;">Clear Cart</button>
        </form>
    </div>

{% else %}
    <div class="cart-item">
        <p>Your cart is empty.</p>
        <p style="margin-top: 10px;"><a href="{{ url_for('search') }}">Search for products</a> to add to your cart.</p>
    </div>
{% endif %}

<div style="margin-top: 30px; padding: 15px; border: 1px solid #000;">
    <p><strong>Note:</strong> To complete your order, please use the official Picnic mobile app or website.</p>
</div>
{% endblock %}
